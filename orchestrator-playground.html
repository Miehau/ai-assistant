<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DynamicController Orchestrator Playground</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0f1117; --bg2: #1a1d27; --bg3: #242836; --bg4: #2e3345;
    --text: #e2e8f0; --text2: #94a3b8; --text3: #64748b;
    --blue: #3b82f6; --blue2: #1d4ed8; --blue-dim: #1e3a5f;
    --green: #10b981; --green-dim: #064e3b;
    --red: #ef4444; --red-dim: #7f1d1d;
    --yellow: #f59e0b; --yellow-dim: #78350f;
    --purple: #8b5cf6; --purple-dim: #4c1d95;
    --cyan: #06b6d4; --orange: #f97316;
    --border: #334155; --radius: 8px;
  }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
  .header { display: flex; align-items: center; gap: 12px; padding: 12px 20px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .header h1 { font-size: 16px; font-weight: 600; }
  .header .subtitle { font-size: 12px; color: var(--text2); }
  .tabs { display: flex; gap: 2px; padding: 0 20px; background: var(--bg2); border-bottom: 1px solid var(--border); flex-shrink: 0; }
  .tab { padding: 10px 18px; font-size: 13px; color: var(--text2); cursor: pointer; border-bottom: 2px solid transparent; transition: all .15s; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--blue); border-bottom-color: var(--blue); }
  .panel { display: none; flex: 1; overflow: auto; }
  .panel.active { display: flex; }

  /* === State Machine Panel === */
  .sm-panel { flex-direction: column; align-items: center; padding: 30px; gap: 20px; }
  .sm-canvas { width: 100%; max-width: 960px; }
  .sm-legend { display: flex; gap: 16px; flex-wrap: wrap; justify-content: center; }
  .sm-legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text2); }
  .sm-legend-dot { width: 12px; height: 12px; border-radius: 3px; }

  /* === Simulation Panel === */
  .sim-panel { flex-direction: row; }
  .sim-controls { width: 280px; padding: 16px; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; overflow-y: auto; flex-shrink: 0; }
  .sim-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
  .sim-flow { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
  .sim-messages { height: 200px; border-top: 1px solid var(--border); padding: 12px; overflow-y: auto; flex-shrink: 0; }
  .sim-messages h3 { font-size: 12px; color: var(--text3); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

  .ctrl-group { display: flex; flex-direction: column; gap: 6px; }
  .ctrl-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; }
  .ctrl-btn { padding: 8px 12px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg3); color: var(--text); cursor: pointer; font-size: 13px; text-align: left; transition: all .15s; font-family: inherit; }
  .ctrl-btn:hover { border-color: var(--blue); background: var(--bg4); }
  .ctrl-btn.primary { background: var(--blue2); border-color: var(--blue); }
  .ctrl-btn.primary:hover { background: var(--blue); }
  .ctrl-btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .step-card { padding: 10px 14px; border-radius: var(--radius); border: 1px solid var(--border); background: var(--bg2); font-size: 13px; display: flex; align-items: flex-start; gap: 10px; }
  .step-dot { width: 10px; height: 10px; border-radius: 50%; margin-top: 3px; flex-shrink: 0; }
  .step-card .step-content { flex: 1; }
  .step-card .step-label { font-weight: 500; }
  .step-card .step-detail { font-size: 11px; color: var(--text2); margin-top: 2px; }
  .step-card.active { border-color: var(--blue); background: var(--blue-dim); }
  .step-card.completed { opacity: 0.6; }

  .phase-badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .phase-controller { background: var(--blue-dim); color: var(--blue); }
  .phase-executing { background: var(--green-dim); color: var(--green); }
  .phase-complete { background: var(--green-dim); color: var(--green); }
  .phase-needs-input { background: var(--yellow-dim); color: var(--yellow); }
  .phase-guardrail { background: var(--red-dim); color: var(--red); }
  .phase-approval { background: var(--purple-dim); color: var(--purple); }

  .msg-item { padding: 6px 10px; border-radius: 4px; font-size: 12px; font-family: 'SF Mono', 'Fira Code', monospace; margin-bottom: 4px; }
  .msg-system { background: #1e293b; color: var(--cyan); }
  .msg-user { background: #1a2e1a; color: var(--green); }
  .msg-tool { background: #2a1a2e; color: var(--purple); }

  /* === Parser Panel === */
  .parser-panel { flex-direction: row; }
  .parser-input { width: 50%; padding: 16px; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 12px; }
  .parser-output { width: 50%; padding: 16px; display: flex; flex-direction: column; gap: 12px; overflow-y: auto; }
  .parser-textarea { flex: 1; background: var(--bg3); color: var(--text); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; resize: none; outline: none; min-height: 200px; }
  .parser-textarea:focus { border-color: var(--blue); }
  .parser-result { padding: 12px; border-radius: var(--radius); font-family: 'SF Mono', 'Fira Code', monospace; font-size: 13px; white-space: pre-wrap; word-break: break-word; }
  .parser-result.success { background: var(--green-dim); border: 1px solid #065f46; }
  .parser-result.error { background: var(--red-dim); border: 1px solid #991b1b; }
  .parser-step { padding: 8px 12px; border-radius: var(--radius); background: var(--bg3); border: 1px solid var(--border); font-size: 12px; }
  .parser-step .step-name { color: var(--blue); font-weight: 600; margin-bottom: 4px; }
  .parser-presets { display: flex; flex-wrap: wrap; gap: 6px; }
  .preset-btn { padding: 4px 10px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg3); color: var(--text2); cursor: pointer; font-size: 11px; font-family: inherit; }
  .preset-btn:hover { border-color: var(--blue); color: var(--text); }

  /* === Tool Exec Panel === */
  .tool-panel { flex-direction: column; padding: 24px; gap: 20px; overflow-y: auto; }
  .pipeline { display: flex; flex-direction: column; gap: 0; max-width: 700px; margin: 0 auto; width: 100%; }
  .pipe-stage { display: flex; align-items: stretch; gap: 0; }
  .pipe-node { flex: 1; padding: 14px 18px; border: 1px solid var(--border); background: var(--bg2); border-radius: var(--radius); position: relative; }
  .pipe-node h4 { font-size: 13px; margin-bottom: 4px; }
  .pipe-node p { font-size: 11px; color: var(--text2); line-height: 1.5; }
  .pipe-node.highlight { border-color: var(--blue); background: var(--blue-dim); }
  .pipe-node.success-hl { border-color: var(--green); background: var(--green-dim); }
  .pipe-node.warn-hl { border-color: var(--yellow); background: var(--yellow-dim); }
  .pipe-node.error-hl { border-color: var(--red); background: var(--red-dim); }
  .pipe-node.purple-hl { border-color: var(--purple); background: var(--purple-dim); }
  .pipe-arrow { text-align: center; padding: 4px 0; color: var(--text3); font-size: 14px; }
  .pipe-branch { display: flex; gap: 12px; margin: 0; }
  .pipe-branch .pipe-node { flex: 1; }

  .tool-controls { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; max-width: 700px; margin: 0 auto; }

  /* === Data Model Panel === */
  .dm-panel { justify-content: center; align-items: center; padding: 30px; }
  .dm-canvas { width: 100%; max-width: 1000px; }

  /* === Prompt Panel === */
  .prompt-panel { padding: 16px; border-top: 1px solid var(--border); background: var(--bg2); flex-shrink: 0; display: none; }
  .prompt-box { position: relative; }
  .prompt-text { background: var(--bg3); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; font-size: 12px; font-family: 'SF Mono', 'Fira Code', monospace; color: var(--text2); max-height: 120px; overflow-y: auto; white-space: pre-wrap; }
  .copy-btn { position: absolute; top: 8px; right: 8px; padding: 4px 12px; border-radius: 4px; border: 1px solid var(--border); background: var(--bg4); color: var(--text2); cursor: pointer; font-size: 11px; font-family: inherit; }
  .copy-btn:hover { border-color: var(--blue); color: var(--text); }

  .section-title { font-size: 14px; font-weight: 600; color: var(--text); }
  .section-sub { font-size: 12px; color: var(--text2); }

  .tag { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; }
  .tag-blue { background: var(--blue-dim); color: var(--blue); }
  .tag-green { background: var(--green-dim); color: var(--green); }
  .tag-red { background: var(--red-dim); color: var(--red); }
  .tag-yellow { background: var(--yellow-dim); color: var(--yellow); }
  .tag-purple { background: var(--purple-dim); color: var(--purple); }
</style>
</head>
<body>

<div class="header">
  <h1>DynamicController Orchestrator</h1>
  <span class="subtitle">src-tauri/src/agent/orchestrator.rs</span>
</div>

<div class="tabs">
  <button class="tab active" onclick="switchTab('sm')">State Machine</button>
  <button class="tab" onclick="switchTab('sim')">Loop Simulation</button>
  <button class="tab" onclick="switchTab('parser')">Action Parser</button>
  <button class="tab" onclick="switchTab('tool')">Tool Execution</button>
  <button class="tab" onclick="switchTab('dm')">Data Model</button>
</div>

<!-- ==================== STATE MACHINE ==================== -->
<div id="panel-sm" class="panel active sm-panel">
  <svg class="sm-canvas" viewBox="0 0 920 520" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <marker id="arrow-blue" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#3b82f6"/></marker>
      <marker id="arrow-green" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#10b981"/></marker>
      <marker id="arrow-red" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#ef4444"/></marker>
      <marker id="arrow-yellow" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#f59e0b"/></marker>
      <marker id="arrow-purple" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#8b5cf6"/></marker>
      <marker id="arrow-gray" markerWidth="8" markerHeight="6" refX="7" refY="3" orient="auto"><polygon points="0 0,8 3,0 6" fill="#64748b"/></marker>
    </defs>

    <!-- Background grid -->
    <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
      <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#1e293b" stroke-width="0.5"/>
    </pattern>
    <rect width="920" height="520" fill="url(#grid)"/>

    <!-- Entry -->
    <circle cx="60" cy="170" r="14" fill="none" stroke="#64748b" stroke-width="2"/>
    <circle cx="60" cy="170" r="6" fill="#64748b"/>
    <text x="60" y="205" text-anchor="middle" fill="#64748b" font-size="11">run()</text>

    <!-- Controller -->
    <rect x="120" y="140" width="170" height="60" rx="8" fill="#1e3a5f" stroke="#3b82f6" stroke-width="2"/>
    <text x="205" y="165" text-anchor="middle" fill="#3b82f6" font-size="14" font-weight="600">Controller</text>
    <text x="205" y="182" text-anchor="middle" fill="#94a3b8" font-size="10">call_controller()</text>

    <!-- Arrow: entry -> controller -->
    <line x1="74" y1="170" x2="118" y2="170" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow-gray)"/>

    <!-- Parse -->
    <rect x="340" y="140" width="160" height="60" rx="8" fill="#1a2e1a" stroke="#10b981" stroke-width="1.5" stroke-dasharray="6,3"/>
    <text x="420" y="165" text-anchor="middle" fill="#10b981" font-size="13" font-weight="600">Parse Action</text>
    <text x="420" y="182" text-anchor="middle" fill="#94a3b8" font-size="10">normalize + validate</text>

    <!-- Arrow: controller -> parse -->
    <line x1="290" y1="170" x2="338" y2="170" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-blue)"/>
    <text x="314" y="162" text-anchor="middle" fill="#94a3b8" font-size="9">JSON</text>

    <!-- Executing -->
    <rect x="340" y="260" width="160" height="60" rx="8" fill="#064e3b" stroke="#10b981" stroke-width="2"/>
    <text x="420" y="285" text-anchor="middle" fill="#10b981" font-size="14" font-weight="600">Executing</text>
    <text x="420" y="302" text-anchor="middle" fill="#94a3b8" font-size="10">execute_flat_step()</text>

    <!-- Arrow: parse -> executing (NextStep) -->
    <path d="M 420 200 L 420 258" fill="none" stroke="#10b981" stroke-width="1.5" marker-end="url(#arrow-green)"/>
    <text x="440" y="232" fill="#10b981" font-size="10">NextStep</text>

    <!-- Approval Wait -->
    <rect x="560" y="260" width="150" height="60" rx="8" fill="#4c1d95" stroke="#8b5cf6" stroke-width="2"/>
    <text x="635" y="285" text-anchor="middle" fill="#8b5cf6" font-size="13" font-weight="600">Approval Wait</text>
    <text x="635" y="302" text-anchor="middle" fill="#94a3b8" font-size="10">mpsc channel poll</text>

    <!-- Arrow: executing -> approval -->
    <line x1="500" y1="290" x2="558" y2="290" stroke="#8b5cf6" stroke-width="1.5" marker-end="url(#arrow-purple)"/>
    <text x="530" y="282" fill="#94a3b8" font-size="9">if req.</text>

    <!-- Loop back: executing -> controller -->
    <path d="M 340 290 C 300 290, 260 260, 205 202" fill="none" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-blue)"/>
    <text x="248" y="258" fill="#3b82f6" font-size="10">Continue</text>

    <!-- Complete -->
    <rect x="560" y="50" width="150" height="55" rx="8" fill="#064e3b" stroke="#10b981" stroke-width="2"/>
    <text x="635" y="75" text-anchor="middle" fill="#10b981" font-size="14" font-weight="600">Complete</text>
    <text x="635" y="92" text-anchor="middle" fill="#94a3b8" font-size="10">finish() → Ok(response)</text>

    <!-- Arrow: parse -> complete -->
    <path d="M 500 160 L 558 100" fill="none" stroke="#10b981" stroke-width="1.5" marker-end="url(#arrow-green)"/>
    <text x="542" y="122" fill="#10b981" font-size="10">Complete</text>

    <!-- AskUser / NeedsHumanInput -->
    <rect x="560" y="140" width="150" height="55" rx="8" fill="#78350f" stroke="#f59e0b" stroke-width="2"/>
    <text x="635" y="162" text-anchor="middle" fill="#f59e0b" font-size="13" font-weight="600">NeedsHumanInput</text>
    <text x="635" y="179" text-anchor="middle" fill="#94a3b8" font-size="10">finish(question)</text>

    <!-- Arrow: parse -> ask_user -->
    <path d="M 500 170 L 558 167" fill="none" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#arrow-yellow)"/>
    <text x="535" y="160" fill="#f59e0b" font-size="10">AskUser</text>

    <!-- GuardrailStop -->
    <rect x="750" y="140" width="150" height="55" rx="8" fill="#7f1d1d" stroke="#ef4444" stroke-width="2"/>
    <text x="825" y="162" text-anchor="middle" fill="#ef4444" font-size="13" font-weight="600">GuardrailStop</text>
    <text x="825" y="179" text-anchor="middle" fill="#94a3b8" font-size="10">Err(detail)</text>

    <!-- Arrow: parse -> guardrail -->
    <path d="M 500 155 L 748 155" fill="none" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4,4" marker-end="url(#arrow-red)"/>
    <text x="620" y="148" fill="#ef4444" font-size="10">GuardrailStop</text>

    <!-- Respond complete (from executing) -->
    <path d="M 420 320 C 420 380, 560 380, 635 107" fill="none" stroke="#10b981" stroke-width="1.5" stroke-dasharray="6,3" marker-end="url(#arrow-green)"/>
    <text x="510" y="370" fill="#10b981" font-size="10">respond / ask_user</text>

    <!-- Denied (from approval) -->
    <path d="M 635 320 C 635 370, 700 400, 635 107" fill="none" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4,4" marker-end="url(#arrow-red)"/>
    <text x="685" y="380" fill="#ef4444" font-size="10">denied</text>

    <!-- Approved back to executing -->
    <path d="M 560 305 L 502 305" fill="none" stroke="#10b981" stroke-width="1.5" marker-end="url(#arrow-green)"/>
    <text x="530" y="318" fill="#94a3b8" font-size="9">approved</text>

    <!-- append_tool_result label on loop back -->
    <text x="225" y="280" fill="#94a3b8" font-size="9" font-style="italic">append_tool_result</text>

    <!-- Turn counter box -->
    <rect x="120" y="60" width="170" height="40" rx="6" fill="var(--bg3)" stroke="#334155" stroke-width="1"/>
    <text x="205" y="78" text-anchor="middle" fill="#94a3b8" font-size="10">turns++ (max: max_total_llm_turns)</text>
    <text x="205" y="92" text-anchor="middle" fill="#64748b" font-size="9">cancel check each iteration</text>

    <!-- Arrow from turn counter to controller -->
    <line x1="205" y1="100" x2="205" y2="138" stroke="#334155" stroke-width="1" stroke-dasharray="3,3"/>

    <!-- Cancellation -->
    <rect x="750" y="260" width="150" height="55" rx="8" fill="#7f1d1d" stroke="#ef4444" stroke-width="1.5" stroke-dasharray="4,4"/>
    <text x="825" y="282" text-anchor="middle" fill="#ef4444" font-size="12" font-weight="500">Cancelled</text>
    <text x="825" y="298" text-anchor="middle" fill="#94a3b8" font-size="10">Err("Cancelled")</text>

    <path d="M 710 285 L 748 285" fill="none" stroke="#ef4444" stroke-width="1" stroke-dasharray="3,3" marker-end="url(#arrow-red)"/>
    <text x="729" y="278" fill="#64748b" font-size="8">timeout</text>

    <!-- Persist decision -->
    <rect x="340" y="380" width="160" height="50" rx="6" fill="var(--bg3)" stroke="#64748b" stroke-width="1" stroke-dasharray="4,4"/>
    <text x="420" y="402" text-anchor="middle" fill="#94a3b8" font-size="11">Persist Decision</text>
    <text x="420" y="416" text-anchor="middle" fill="#64748b" font-size="9">&gt;4K auto | &gt;16K forced</text>

    <line x1="420" y1="320" x2="420" y2="378" stroke="#64748b" stroke-width="1" stroke-dasharray="3,3" marker-end="url(#arrow-gray)"/>

    <!-- Event Bus -->
    <rect x="120" y="430" width="780" height="40" rx="6" fill="#1a1d27" stroke="#334155" stroke-width="1"/>
    <text x="510" y="455" text-anchor="middle" fill="#64748b" font-size="11">EventBus: STEP_PROPOSED | STEP_STARTED | TOOL_PROPOSED | TOOL_APPROVED/DENIED | TOOL_COMPLETED | STEP_COMPLETED | PHASE_CHANGED | COMPLETED</text>

    <!-- Arrows down to event bus -->
    <line x1="205" y1="200" x2="205" y2="428" stroke="#1e293b" stroke-width="1" stroke-dasharray="2,4"/>
    <line x1="420" y1="430" x2="420" y2="428" stroke="#1e293b" stroke-width="1" stroke-dasharray="2,4"/>
    <line x1="635" y1="320" x2="635" y2="428" stroke="#1e293b" stroke-width="1" stroke-dasharray="2,4"/>
  </svg>

  <div class="sm-legend">
    <div class="sm-legend-item"><div class="sm-legend-dot" style="background:#3b82f6"></div>Controller (LLM decision)</div>
    <div class="sm-legend-item"><div class="sm-legend-dot" style="background:#10b981"></div>Execution (tool/respond)</div>
    <div class="sm-legend-item"><div class="sm-legend-dot" style="background:#8b5cf6"></div>Approval wait</div>
    <div class="sm-legend-item"><div class="sm-legend-dot" style="background:#f59e0b"></div>User input needed</div>
    <div class="sm-legend-item"><div class="sm-legend-dot" style="background:#ef4444"></div>Error/stop/denied</div>
    <div class="sm-legend-item"><div class="sm-legend-dot" style="background:#64748b"></div>Internal plumbing</div>
  </div>
</div>

<!-- ==================== LOOP SIMULATION ==================== -->
<div id="panel-sim" class="panel sim-panel">
  <div class="sim-controls">
    <div class="section-title">Loop Simulation</div>
    <div class="section-sub">Simulate the run() main loop</div>

    <div class="ctrl-group">
      <div class="ctrl-label">Current Phase</div>
      <div id="sim-phase" class="phase-badge phase-controller">Controller</div>
    </div>

    <div class="ctrl-group">
      <div class="ctrl-label">Turn: <span id="sim-turn">0</span> / <span id="sim-max">10</span></div>
    </div>

    <div class="ctrl-group">
      <div class="ctrl-label">LLM Returns...</div>
      <button class="ctrl-btn" onclick="simAction('tool')">NextStep (tool call)</button>
      <button class="ctrl-btn" onclick="simAction('respond')">NextStep (respond)</button>
      <button class="ctrl-btn" onclick="simAction('ask_user')">NextStep (ask_user)</button>
      <button class="ctrl-btn" onclick="simAction('complete')">Complete</button>
      <button class="ctrl-btn" onclick="simAction('guardrail')">GuardrailStop</button>
      <button class="ctrl-btn" onclick="simAction('ask')">AskUser (top-level)</button>
    </div>

    <hr style="border-color: var(--border)">

    <button class="ctrl-btn primary" onclick="simReset()">Reset Simulation</button>
  </div>

  <div class="sim-main">
    <div id="sim-flow" class="sim-flow">
      <div class="step-card active">
        <div class="step-dot" style="background: var(--blue)"></div>
        <div class="step-content">
          <div class="step-label">Waiting for first action...</div>
          <div class="step-detail">Choose an LLM response from the left panel</div>
        </div>
      </div>
    </div>

    <div class="sim-messages">
      <h3>Controller Message History</h3>
      <div id="sim-msg-list">
        <div class="msg-item msg-system">[system] CONTROLLER_PROMPT_BASE (cached)</div>
        <div class="msg-item msg-system">[system] AVAILABLE TOOLS JSON (cached)</div>
        <div class="msg-item msg-user">[user] "Help me analyze this data..."</div>
      </div>
    </div>
  </div>
</div>

<!-- ==================== PARSER ==================== -->
<div id="panel-parser" class="panel parser-panel">
  <div class="parser-input">
    <div class="section-title">Controller JSON Input</div>
    <div class="section-sub">Edit the JSON to see how parse_controller_action processes it</div>

    <div class="ctrl-group">
      <div class="ctrl-label">Presets</div>
      <div class="parser-presets">
        <button class="preset-btn" onclick="loadPreset('tool')">Tool Call</button>
        <button class="preset-btn" onclick="loadPreset('respond')">Respond</button>
        <button class="preset-btn" onclick="loadPreset('ask')">Ask User</button>
        <button class="preset-btn" onclick="loadPreset('complete')">Complete</button>
        <button class="preset-btn" onclick="loadPreset('alias')">With Aliases</button>
        <button class="preset-btn" onclick="loadPreset('nested')">Nested Step</button>
        <button class="preset-btn" onclick="loadPreset('string_args')">String Args</button>
        <button class="preset-btn" onclick="loadPreset('think_only')">Think Only</button>
        <button class="preset-btn" onclick="loadPreset('respond_action')">action=respond</button>
        <button class="preset-btn" onclick="loadPreset('blank_q')">Blank Question</button>
      </div>
    </div>

    <textarea id="parser-input" class="parser-textarea" spellcheck="false">{
  "action": "next_step",
  "thinking": { "task": "Check weather" },
  "tool": "weather.get_forecast",
  "args": { "city": "London" }
}</textarea>
  </div>

  <div class="parser-output">
    <div class="section-title">Processing Pipeline</div>

    <div id="parse-step-1" class="parser-step">
      <div class="step-name">1. normalize_controller_value()</div>
      <div id="parse-norm-out"></div>
    </div>

    <div id="parse-step-2" class="parser-step">
      <div class="step-name">2. serde deserialize &rarr; ControllerAction</div>
      <div id="parse-deser-out"></div>
    </div>

    <div id="parse-step-3" class="parser-step">
      <div class="step-name">3. validate() + type inference</div>
      <div id="parse-validate-out"></div>
    </div>

    <div class="section-title" style="margin-top: 8px;">Final Result</div>
    <div id="parse-result" class="parser-result success"></div>
  </div>
</div>

<!-- ==================== TOOL EXECUTION ==================== -->
<div id="panel-tool" class="panel tool-panel">
  <div class="section-title" style="text-align:center">Tool Execution Pipeline</div>
  <div class="section-sub" style="text-align:center">Click stages to highlight the active step</div>

  <div class="tool-controls">
    <button class="ctrl-btn" onclick="toolStage('args')">1. Arg Processing</button>
    <button class="ctrl-btn" onclick="toolStage('validate')">2. Validate</button>
    <button class="ctrl-btn" onclick="toolStage('approval')">3. Approval</button>
    <button class="ctrl-btn" onclick="toolStage('execute')">4. Execute</button>
    <button class="ctrl-btn" onclick="toolStage('persist')">5. Persist</button>
    <button class="ctrl-btn" onclick="toolStage('record')">6. Record</button>
    <button class="ctrl-btn primary" onclick="toolStage(null)">Reset</button>
  </div>

  <div class="pipeline" id="tool-pipeline">
    <div class="pipe-stage">
      <div class="pipe-node" id="tn-args">
        <h4>Arg Processing</h4>
        <p><strong>normalize_tool_args:</strong> null&rarr;{}, string&rarr;parse JSON, passthrough objects</p>
        <p style="margin-top:4px"><strong>hydrate_tool_args:</strong> For <span class="tag tag-purple">tool_outputs.*</span> tools only &mdash; injects <code>id</code> from last persisted output_ref, injects <code>conversation_id</code> for tool_outputs.read, defaults <code>paths: ["$"]</code> for extract</p>
      </div>
    </div>
    <div class="pipe-arrow">&darr;</div>

    <div class="pipe-stage">
      <div class="pipe-node" id="tn-validate">
        <h4>Validate</h4>
        <p><strong>Registry lookup:</strong> tool_registry.get(tool_name) &rarr; Unknown tool error if missing</p>
        <p style="margin-top:4px"><strong>Arg validation:</strong> tool_registry.validate_args() &rarr; preflight failure on schema mismatch</p>
        <p style="margin-top:4px;color:var(--red)">Either failure returns build_preflight_failed_step_result (no execution)</p>
      </div>
    </div>
    <div class="pipe-arrow">&darr;</div>

    <div class="pipe-stage">
      <div class="pipe-node" id="tn-approval">
        <h4>Approval Check</h4>
        <p><strong>3-tier override:</strong></p>
        <p>1. conversation_tool_approval_override(conv_id, tool) <span class="tag tag-blue">highest priority</span></p>
        <p>2. global tool_approval_override(tool) <span class="tag tag-green">fallback</span></p>
        <p>3. tool.metadata.requires_approval <span class="tag tag-yellow">default</span></p>
        <p style="margin-top:6px"><strong>If requires approval:</strong></p>
        <p>Publish TOOL_PROPOSED &rarr; block on mpsc channel &rarr; poll 200ms with cancel check</p>
        <p>Outcomes: <span class="tag tag-green">Approved</span> <span class="tag tag-red">Denied</span> <span class="tag tag-yellow">Timeout</span> <span class="tag tag-red">Cancelled</span></p>
      </div>
    </div>
    <div class="pipe-arrow">&darr;</div>

    <div class="pipe-stage">
      <div class="pipe-node" id="tn-execute">
        <h4>Execute Tool</h4>
        <p><strong>execute_tool_with_timeout:</strong> Spawns handler in std::thread</p>
        <p>Polls mpsc channel every 200ms, checks cancel_flag each iteration</p>
        <p>Timeout: <code>tool_execution_timeout_ms</code> (0 = no timeout, direct call)</p>
        <p style="margin-top:4px">Returns: <span class="tag tag-green">Ok(Value)</span> or <span class="tag tag-red">Err(String)</span></p>
      </div>
    </div>
    <div class="pipe-arrow">&darr;</div>

    <div class="pipe-stage">
      <div class="pipe-node" id="tn-persist">
        <h4>Output Persistence Decision</h4>
        <p><strong>should_persist_tool_output:</strong></p>
        <p><span class="tag tag-purple">tool_outputs.*</span> &rarr; never persist (always inline)</p>
        <p><span class="tag tag-blue">ToolResultMode::Inline</span> &rarr; persist only if &gt; 16,384 chars</p>
        <p><span class="tag tag-green">ToolResultMode::Auto</span> &rarr; persist if &gt; 4,096 chars</p>
        <p><span class="tag tag-yellow">ToolResultMode::Persist</span> &rarr; always persist</p>
        <p style="margin-top:6px"><strong>Persisted result includes:</strong> output_ref, preview (1200 chars), metadata (root_type, keys/length), available_tools hints</p>
      </div>
    </div>
    <div class="pipe-arrow">&darr;</div>

    <div class="pipe-stage">
      <div class="pipe-node" id="tn-record">
        <h4>Record & Report</h4>
        <p><strong>ToolExecutionRecord</strong> &rarr; pushed to step_result.tool_executions</p>
        <p><strong>MessageToolExecutionInput</strong> &rarr; pushed to pending_tool_executions (for DB save)</p>
        <p><strong>EVENT_TOOL_EXECUTION_COMPLETED</strong> &rarr; published to EventBus</p>
        <p style="margin-top:4px"><strong>append_tool_result_message:</strong> Summarized tool result appended to self.messages as [user] for next controller turn</p>
        <p style="font-size:10px;color:var(--text3);margin-top:4px">Summary: "Tool: X | Success: true | Args: {...} | Result: {...}" (max 2000 chars)</p>
      </div>
    </div>
  </div>
</div>

<!-- ==================== DATA MODEL ==================== -->
<div id="panel-dm" class="panel dm-panel">
  <svg class="dm-canvas" viewBox="0 0 960 580" xmlns="http://www.w3.org/2000/svg">
    <pattern id="grid2" width="20" height="20" patternUnits="userSpaceOnUse">
      <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#1e293b" stroke-width="0.5"/>
    </pattern>
    <rect width="960" height="580" fill="url(#grid2)"/>

    <!-- Conversation -->
    <rect x="30" y="30" width="220" height="130" rx="8" fill="#1e3a5f" stroke="#3b82f6" stroke-width="2"/>
    <text x="140" y="55" text-anchor="middle" fill="#3b82f6" font-size="15" font-weight="700">Conversation</text>
    <line x1="40" y1="65" x2="240" y2="65" stroke="#334155" stroke-width="1"/>
    <text x="45" y="82" fill="#e2e8f0" font-size="11" font-family="monospace">id: String (PK)</text>
    <text x="45" y="98" fill="#e2e8f0" font-size="11" font-family="monospace">name: String</text>
    <text x="45" y="114" fill="#e2e8f0" font-size="11" font-family="monospace">created_at: DateTime</text>
    <text x="45" y="135" fill="#64748b" font-size="10">Table: conversations</text>

    <!-- Message -->
    <rect x="30" y="210" width="220" height="170" rx="8" fill="#064e3b" stroke="#10b981" stroke-width="2"/>
    <text x="140" y="235" text-anchor="middle" fill="#10b981" font-size="15" font-weight="700">Message</text>
    <line x1="40" y1="245" x2="240" y2="245" stroke="#334155" stroke-width="1"/>
    <text x="45" y="262" fill="#e2e8f0" font-size="11" font-family="monospace">id: String (PK)</text>
    <text x="45" y="278" fill="#e2e8f0" font-size="11" font-family="monospace">content: String</text>
    <text x="45" y="294" fill="#e2e8f0" font-size="11" font-family="monospace">role: "user"|"assistant"</text>
    <text x="45" y="310" fill="#3b82f6" font-size="11" font-family="monospace">conversation_id: FK</text>
    <text x="45" y="326" fill="#e2e8f0" font-size="11" font-family="monospace">created_at: DateTime</text>
    <text x="45" y="350" fill="#64748b" font-size="10">+ attachments[], tool_executions[]</text>

    <!-- FK line: Conversation -> Message -->
    <line x1="140" y1="160" x2="140" y2="208" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-blue)"/>
    <text x="148" y="188" fill="#94a3b8" font-size="9">1:N</text>

    <!-- MessageAttachment -->
    <rect x="30" y="430" width="220" height="100" rx="8" fill="#1a1d27" stroke="#64748b" stroke-width="1.5"/>
    <text x="140" y="455" text-anchor="middle" fill="#94a3b8" font-size="13" font-weight="600">MessageAttachment</text>
    <line x1="40" y1="463" x2="240" y2="463" stroke="#334155" stroke-width="1"/>
    <text x="45" y="480" fill="#e2e8f0" font-size="10" font-family="monospace">name, data, type, mime_type</text>
    <text x="45" y="496" fill="#e2e8f0" font-size="10" font-family="monospace">file_path, size_bytes</text>
    <text x="45" y="512" fill="#e2e8f0" font-size="10" font-family="monospace">transcript, description</text>

    <line x1="100" y1="380" x2="100" y2="428" stroke="#64748b" stroke-width="1" marker-end="url(#arrow-gray)"/>
    <text x="108" y="408" fill="#64748b" font-size="9">1:N</text>

    <!-- MessageToolExecution -->
    <rect x="280" y="430" width="220" height="100" rx="8" fill="#1a1d27" stroke="#8b5cf6" stroke-width="1.5"/>
    <text x="390" y="455" text-anchor="middle" fill="#8b5cf6" font-size="13" font-weight="600">MessageToolExecution</text>
    <line x1="290" y1="463" x2="490" y2="463" stroke="#334155" stroke-width="1"/>
    <text x="295" y="480" fill="#e2e8f0" font-size="10" font-family="monospace">tool_name, parameters: JSON</text>
    <text x="295" y="496" fill="#e2e8f0" font-size="10" font-family="monospace">result: JSON, success, error</text>
    <text x="295" y="512" fill="#e2e8f0" font-size="10" font-family="monospace">duration_ms, iteration_number</text>

    <path d="M 180 380 C 180 410, 350 410, 350 428" fill="none" stroke="#8b5cf6" stroke-width="1" marker-end="url(#arrow-purple)"/>
    <text x="260" y="408" fill="#64748b" font-size="9">1:N</text>

    <!-- AgentSession -->
    <rect x="340" y="30" width="240" height="180" rx="8" fill="#4c1d95" stroke="#8b5cf6" stroke-width="2"/>
    <text x="460" y="55" text-anchor="middle" fill="#8b5cf6" font-size="15" font-weight="700">AgentSession</text>
    <line x1="350" y1="65" x2="570" y2="65" stroke="#5b21b6" stroke-width="1"/>
    <text x="355" y="82" fill="#e2e8f0" font-size="11" font-family="monospace">id: String (PK)</text>
    <text x="355" y="98" fill="#3b82f6" font-size="11" font-family="monospace">conversation_id: FK</text>
    <text x="355" y="114" fill="#3b82f6" font-size="11" font-family="monospace">message_id: FK</text>
    <text x="355" y="130" fill="#e2e8f0" font-size="11" font-family="monospace">phase: PhaseKind (JSON)</text>
    <text x="355" y="146" fill="#e2e8f0" font-size="11" font-family="monospace">config: AgentConfig (JSON)</text>
    <text x="355" y="162" fill="#e2e8f0" font-size="11" font-family="monospace">created_at, updated_at</text>
    <text x="355" y="178" fill="#e2e8f0" font-size="11" font-family="monospace">completed_at: Option</text>
    <text x="355" y="198" fill="#64748b" font-size="10">Table: agent_sessions</text>

    <!-- FK: Conversation -> AgentSession -->
    <path d="M 250 90 L 338 90" fill="none" stroke="#3b82f6" stroke-width="1.5" marker-end="url(#arrow-blue)"/>
    <text x="295" y="85" fill="#94a3b8" font-size="9">1:N</text>

    <!-- Plan -->
    <rect x="670" y="30" width="240" height="140" rx="8" fill="#78350f" stroke="#f59e0b" stroke-width="2"/>
    <text x="790" y="55" text-anchor="middle" fill="#f59e0b" font-size="15" font-weight="700">Plan</text>
    <line x1="680" y1="65" x2="900" y2="65" stroke="#92400e" stroke-width="1"/>
    <text x="685" y="82" fill="#e2e8f0" font-size="11" font-family="monospace">id: String (PK)</text>
    <text x="685" y="98" fill="#8b5cf6" font-size="11" font-family="monospace">session_id: FK</text>
    <text x="685" y="114" fill="#e2e8f0" font-size="11" font-family="monospace">goal: String</text>
    <text x="685" y="130" fill="#e2e8f0" font-size="11" font-family="monospace">assumptions: JSON array</text>
    <text x="685" y="146" fill="#e2e8f0" font-size="11" font-family="monospace">revision_number: u32</text>
    <text x="685" y="162" fill="#64748b" font-size="10">Table: agent_plans</text>

    <!-- FK: Session -> Plan -->
    <path d="M 580 80 L 668 80" fill="none" stroke="#f59e0b" stroke-width="1.5" marker-end="url(#arrow-yellow)"/>
    <text x="625" y="75" fill="#94a3b8" font-size="9">0..1</text>

    <!-- PlanStep -->
    <rect x="670" y="220" width="240" height="160" rx="8" fill="#1a2e1a" stroke="#10b981" stroke-width="2"/>
    <text x="790" y="245" text-anchor="middle" fill="#10b981" font-size="15" font-weight="700">PlanStep</text>
    <line x1="680" y1="255" x2="900" y2="255" stroke="#065f46" stroke-width="1"/>
    <text x="685" y="272" fill="#e2e8f0" font-size="11" font-family="monospace">id: String (PK)</text>
    <text x="685" y="288" fill="#f59e0b" font-size="11" font-family="monospace">plan_id: FK</text>
    <text x="685" y="304" fill="#e2e8f0" font-size="11" font-family="monospace">sequence, description</text>
    <text x="685" y="320" fill="#e2e8f0" font-size="11" font-family="monospace">action: StepAction (JSON)</text>
    <text x="685" y="336" fill="#e2e8f0" font-size="11" font-family="monospace">status: StepStatus</text>
    <text x="685" y="356" fill="#64748b" font-size="10">ToolCall | AskUser | Respond</text>

    <!-- FK: Plan -> PlanStep -->
    <line x1="790" y1="170" x2="790" y2="218" stroke="#10b981" stroke-width="1.5" marker-end="url(#arrow-green)"/>
    <text x="798" y="198" fill="#94a3b8" font-size="9">1:N</text>

    <!-- StepResult -->
    <rect x="670" y="430" width="240" height="120" rx="8" fill="#1e293b" stroke="#06b6d4" stroke-width="2"/>
    <text x="790" y="455" text-anchor="middle" fill="#06b6d4" font-size="15" font-weight="700">StepResult</text>
    <line x1="680" y1="463" x2="900" y2="463" stroke="#334155" stroke-width="1"/>
    <text x="685" y="480" fill="#10b981" font-size="11" font-family="monospace">step_id: FK</text>
    <text x="685" y="496" fill="#e2e8f0" font-size="11" font-family="monospace">success, output: JSON</text>
    <text x="685" y="512" fill="#e2e8f0" font-size="11" font-family="monospace">error, duration_ms</text>
    <text x="685" y="528" fill="#e2e8f0" font-size="11" font-family="monospace">tool_executions: Vec</text>

    <!-- FK: PlanStep -> StepResult -->
    <line x1="790" y1="380" x2="790" y2="428" stroke="#06b6d4" stroke-width="1.5" marker-end="url(#arrow-blue)"/>
    <text x="798" y="408" fill="#94a3b8" font-size="9">0..1</text>

    <!-- PhaseKind legend -->
    <rect x="340" y="260" width="260" height="170" rx="6" fill="#1a1d27" stroke="#334155" stroke-width="1"/>
    <text x="355" y="282" fill="#94a3b8" font-size="12" font-weight="600">PhaseKind enum</text>
    <text x="355" y="302" fill="#3b82f6" font-size="10" font-family="monospace">Controller</text>
    <text x="355" y="318" fill="#10b981" font-size="10" font-family="monospace">Executing { step_id, tool_iter }</text>
    <text x="355" y="334" fill="#10b981" font-size="10" font-family="monospace">Complete { final_response }</text>
    <text x="355" y="350" fill="#f59e0b" font-size="10" font-family="monospace">NeedsHumanInput { question }</text>
    <text x="355" y="366" fill="#ef4444" font-size="10" font-family="monospace">GuardrailStop { reason }</text>
    <text x="355" y="382" fill="#64748b" font-size="10" font-family="monospace">Triage | Clarifying | Planning</text>
    <text x="355" y="398" fill="#64748b" font-size="10" font-family="monospace">ProposingStep | Reflecting</text>

    <path d="M 460 210 L 460 258" fill="none" stroke="#334155" stroke-width="1" stroke-dasharray="3,3"/>
  </svg>
</div>

<!-- ==================== PROMPT OUTPUT ==================== -->
<div class="prompt-panel" id="prompt-panel">
  <div class="prompt-box">
    <div class="prompt-text" id="prompt-text"></div>
    <button class="copy-btn" onclick="copyPrompt()">Copy</button>
  </div>
</div>

<script>
// ==================== TAB SWITCHING ====================
function switchTab(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  document.querySelectorAll('.tab')[['sm','sim','parser','tool','dm'].indexOf(id)].classList.add('active');
}

// ==================== SIMULATION ====================
const simState = { turn: 0, max: 10, phase: 'Controller', steps: [], messages: [], finished: false };

function simReset() {
  simState.turn = 0; simState.phase = 'Controller'; simState.steps = []; simState.finished = false;
  simState.messages = [
    { type: 'system', text: '[system] CONTROLLER_PROMPT_BASE (cached)' },
    { type: 'system', text: '[system] AVAILABLE TOOLS JSON (cached)' },
    { type: 'user', text: '[user] "Help me analyze this data..."' },
  ];
  renderSim();
}

function simAction(action) {
  if (simState.finished) return;
  simState.turn++;
  document.getElementById('sim-turn').textContent = simState.turn;

  if (simState.turn > simState.max) {
    simState.steps.push({ label: 'Exceeded max LLM turns', detail: 'Err("Exceeded maximum LLM turns")', color: 'var(--red)', phase: 'Error' });
    simState.finished = true;
    renderSim();
    return;
  }

  // call_controller
  simState.steps.push({ label: 'call_controller()', detail: 'Build messages array + send to LLM with structured output schema', color: 'var(--blue)', phase: 'Controller' });

  switch (action) {
    case 'tool':
      simState.steps.push({ label: 'parse_controller_action → NextStep(tool)', detail: 'Parsed: action=next_step, tool="data.analyze", args={...}', color: 'var(--green)', phase: 'Parse' });
      simState.steps.push({ label: 'ensure_plan() — create/reuse plan', detail: 'Plan created lazily on first NextStep', color: 'var(--text3)', phase: 'Internal' });
      simState.steps.push({ label: 'execute_flat_step(type="tool")', detail: 'Create PlanStep → publish STEP_PROPOSED → STEP_STARTED', color: 'var(--green)', phase: 'Executing' });
      simState.steps.push({ label: 'execute_tool("data.analyze", {...})', detail: 'Approval check → execute with timeout → persist output', color: 'var(--green)', phase: 'Executing' });
      simState.steps.push({ label: 'append_tool_result_message()', detail: '"Tool: data.analyze | Success: true | Result: {...}" appended as [user] message', color: 'var(--blue)', phase: 'Controller' });
      simState.messages.push({ type: 'tool', text: '[tool result] Tool: data.analyze | Success: true | Args: {...} | Result: {...}' });
      simState.phase = 'Controller';
      break;
    case 'respond':
      simState.steps.push({ label: 'parse_controller_action → NextStep(respond)', detail: 'Inferred type=respond from message field', color: 'var(--green)', phase: 'Parse' });
      simState.steps.push({ label: 'execute_flat_step(type="respond")', detail: 'StepExecutionOutcome::Complete(message)', color: 'var(--green)', phase: 'Complete' });
      simState.steps.push({ label: 'finish(message)', detail: 'Session completed, EVENT_AGENT_COMPLETED published', color: 'var(--green)', phase: 'Complete' });
      simState.phase = 'Complete';
      simState.finished = true;
      break;
    case 'ask_user':
      simState.steps.push({ label: 'parse_controller_action → NextStep(ask_user)', detail: 'Inferred type=ask_user from question field', color: 'var(--yellow)', phase: 'Parse' });
      simState.steps.push({ label: 'execute_flat_step(type="ask_user")', detail: 'requested_user_input = true', color: 'var(--yellow)', phase: 'NeedsHumanInput' });
      simState.steps.push({ label: 'finish(question)', detail: 'Returns question to caller, waits for user response', color: 'var(--yellow)', phase: 'NeedsHumanInput' });
      simState.phase = 'NeedsHumanInput';
      simState.finished = true;
      break;
    case 'complete':
      simState.steps.push({ label: 'parse_controller_action → Complete', detail: 'action="complete", message="Here is your analysis..."', color: 'var(--green)', phase: 'Parse' });
      simState.steps.push({ label: 'finish(message)', detail: 'Session completed, EVENT_AGENT_COMPLETED published', color: 'var(--green)', phase: 'Complete' });
      simState.phase = 'Complete';
      simState.finished = true;
      break;
    case 'guardrail':
      simState.steps.push({ label: 'parse_controller_action → GuardrailStop', detail: 'reason="Content policy violation"', color: 'var(--red)', phase: 'Parse' });
      simState.steps.push({ label: 'set_phase(GuardrailStop)', detail: 'Err(detail) returned', color: 'var(--red)', phase: 'GuardrailStop' });
      simState.phase = 'GuardrailStop';
      simState.finished = true;
      break;
    case 'ask':
      simState.steps.push({ label: 'parse_controller_action → AskUser', detail: 'Top-level ask_user action (separate from NextStep ask_user)', color: 'var(--yellow)', phase: 'Parse' });
      simState.steps.push({ label: 'requested_user_input = true', detail: 'finish(question) — returns question text', color: 'var(--yellow)', phase: 'NeedsHumanInput' });
      simState.phase = 'NeedsHumanInput';
      simState.finished = true;
      break;
  }
  renderSim();
}

function renderSim() {
  const flow = document.getElementById('sim-flow');
  const phaseEl = document.getElementById('sim-phase');

  const phaseMap = {
    'Controller': 'phase-controller', 'Executing': 'phase-executing',
    'Complete': 'phase-complete', 'NeedsHumanInput': 'phase-needs-input',
    'GuardrailStop': 'phase-guardrail', 'Parse': 'phase-controller',
    'Internal': 'phase-controller', 'Error': 'phase-guardrail',
  };
  phaseEl.className = 'phase-badge ' + (phaseMap[simState.phase] || 'phase-controller');
  phaseEl.textContent = simState.phase;

  if (simState.steps.length === 0) {
    flow.innerHTML = '<div class="step-card active"><div class="step-dot" style="background:var(--blue)"></div><div class="step-content"><div class="step-label">Waiting for first action...</div><div class="step-detail">Choose an LLM response from the left panel</div></div></div>';
  } else {
    flow.innerHTML = simState.steps.map((s, i) => {
      const isLast = i === simState.steps.length - 1;
      return `<div class="step-card ${isLast ? 'active' : 'completed'}"><div class="step-dot" style="background:${s.color}"></div><div class="step-content"><div class="step-label">${s.label} <span class="phase-badge ${phaseMap[s.phase] || ''}" style="margin-left:6px">${s.phase}</span></div><div class="step-detail">${s.detail}</div></div></div>`;
    }).join('');
  }

  const msgList = document.getElementById('sim-msg-list');
  msgList.innerHTML = simState.messages.map(m => {
    const cls = m.type === 'system' ? 'msg-system' : m.type === 'user' ? 'msg-user' : 'msg-tool';
    return `<div class="msg-item ${cls}">${m.text}</div>`;
  }).join('');

  flow.scrollTop = flow.scrollHeight;
}

// ==================== PARSER ====================
const presets = {
  tool: { action: "next_step", thinking: { task: "Check weather" }, tool: "weather.get_forecast", args: { city: "London" } },
  respond: { action: "next_step", thinking: { task: "Respond" }, type: "respond", message: "Here is the information you requested." },
  ask: { action: "next_step", thinking: { task: "Need clarification" }, type: "ask_user", question: "Which date range should I use?", context: "Multiple options available" },
  complete: { action: "complete", message: "Task completed successfully. Here are your results." },
  alias: { action: "next_step", thinking: { task: "Search files" }, tool_name: "files.search", arguments: { query: "test" } },
  nested: { action: "next_step", thinking: { task: "Check weather" }, step: { tool: "weather", args: { city: "Austin" } } },
  string_args: { action: "next_step", thinking: { task: "Check" }, tool: "weather", args: '{"location":"Austin, TX"}' },
  think_only: { action: "next_step", thinking: { task: "Inspect project files before deciding" } },
  respond_action: { action: "respond", message: "Here is your answer." },
  blank_q: { action: "next_step", thinking: { task: "Inspect" }, question: "", context: "" },
};

function loadPreset(name) {
  document.getElementById('parser-input').value = JSON.stringify(presets[name], null, 2);
  parseInput();
}

function parseInput() {
  const input = document.getElementById('parser-input').value;
  const normOut = document.getElementById('parse-norm-out');
  const deserOut = document.getElementById('parse-deser-out');
  const valOut = document.getElementById('parse-validate-out');
  const resultEl = document.getElementById('parse-result');

  let parsed;
  try {
    parsed = JSON.parse(input);
  } catch (e) {
    normOut.innerHTML = `<span style="color:var(--red)">Invalid JSON: ${e.message}</span>`;
    deserOut.innerHTML = ''; valOut.innerHTML = '';
    resultEl.className = 'parser-result error';
    resultEl.textContent = 'Parse error: ' + e.message;
    return;
  }

  // Step 1: Normalize
  const normalized = normalizeControllerValue(parsed);
  const normDiffs = [];
  if (JSON.stringify(parsed) !== JSON.stringify(normalized)) {
    if (parsed.step || parsed.next_step) normDiffs.push('Hoisted nested step fields to top level');
    if (parsed.tool_name) normDiffs.push('tool_name → tool');
    if (parsed.name && !parsed.tool) normDiffs.push('name → tool');
    if (parsed.arguments) normDiffs.push('arguments → args');
    if (parsed.tool_args) normDiffs.push('tool_args → args');
    if (parsed.tool_input) normDiffs.push('tool_input → args');
    if (parsed.response && !parsed.message) normDiffs.push('response → message');
    if (parsed.content && !parsed.message) normDiffs.push('content → message');
  }
  normOut.innerHTML = normDiffs.length > 0
    ? `<span style="color:var(--yellow)">Transformations: ${normDiffs.join(', ')}</span><br><code style="font-size:11px;color:var(--text2)">${JSON.stringify(normalized)}</code>`
    : `<span style="color:var(--green)">No transformations needed</span>`;

  // Step 2: Deserialize
  const action = normalized.action;
  let deserResult = null;
  let deserError = null;

  if (action === 'complete') {
    if (normalized.message) {
      deserResult = { type: 'Complete', message: normalized.message };
    } else {
      deserError = 'Complete requires "message" field';
    }
  } else if (action === 'guardrail_stop') {
    if (normalized.reason) {
      deserResult = { type: 'GuardrailStop', reason: normalized.reason };
    } else {
      deserError = 'GuardrailStop requires "reason" field';
    }
  } else if (action === 'ask_user') {
    if (normalized.question && normalized.question.trim()) {
      deserResult = { type: 'AskUser', question: normalized.question };
    } else {
      deserError = 'AskUser requires non-empty "question" field';
    }
  } else if (action === 'next_step') {
    deserResult = { type: 'NextStep', tool: normalized.tool || null, message: normalized.message || null, question: normalized.question || null, args: normalized.args, step_type: normalized.type || null };
  } else if (action === 'respond') {
    // Fallback: action=respond maps to Complete
    const msg = normalized.message || normalized.response;
    if (msg && msg.trim()) {
      deserResult = { type: 'Complete (via respond fallback)', message: msg };
      deserOut.innerHTML = `<span style="color:var(--yellow)">action="respond" mapped to Complete</span>`;
    } else {
      deserError = 'action="respond" requires "message" or "response" field';
    }
  } else {
    deserError = `Unknown action: "${action}"`;
  }

  if (deserError) {
    deserOut.innerHTML = `<span style="color:var(--red)">${deserError}</span>`;
    valOut.innerHTML = '';
    resultEl.className = 'parser-result error';
    resultEl.textContent = 'Invalid controller output: ' + deserError;
    return;
  }
  if (!deserOut.innerHTML) {
    deserOut.innerHTML = `<span style="color:var(--green)">Deserialized to <strong>${deserResult.type}</strong></span>`;
  }

  // Step 3: Validate (for NextStep only)
  if (deserResult.type === 'NextStep') {
    const tool = deserResult.tool;
    const message = deserResult.message;
    const question = deserResult.question;
    const explicitType = deserResult.step_type;

    let inferred = explicitType;
    if (!inferred) {
      if (tool && tool.trim()) inferred = 'tool';
      else if (question && question.trim()) inferred = 'ask_user';
      else if (message && message.trim()) inferred = 'respond';
    }

    if (!inferred) {
      valOut.innerHTML = `<span style="color:var(--red)">Cannot determine step type: no 'type', 'tool', 'message', or 'question' field</span>`;
      resultEl.className = 'parser-result error';
      resultEl.textContent = "Cannot determine step type: provide 'type' or 'tool'/'message'/'question'";
      return;
    }

    if (inferred === 'tool' && (!tool || !tool.trim())) {
      valOut.innerHTML = `<span style="color:var(--red)">type=tool requires non-empty 'tool' field</span>`;
      resultEl.className = 'parser-result error';
      resultEl.textContent = "next_step type=tool requires non-empty 'tool' field";
      return;
    }
    if (inferred === 'respond' && (!message || !message.trim())) {
      valOut.innerHTML = `<span style="color:var(--red)">type=respond requires non-empty 'message' field</span>`;
      resultEl.className = 'parser-result error';
      resultEl.textContent = "next_step type=respond requires non-empty 'message' field";
      return;
    }
    if (inferred === 'ask_user' && (!question || !question.trim())) {
      valOut.innerHTML = `<span style="color:var(--red)">type=ask_user requires non-empty 'question' field</span>`;
      resultEl.className = 'parser-result error';
      resultEl.textContent = "next_step type=ask_user requires non-empty 'question' field";
      return;
    }

    const wasInferred = !explicitType;
    valOut.innerHTML = `<span style="color:var(--green)">Effective type: <strong>${inferred}</strong> ${wasInferred ? '<span class="tag tag-blue">inferred</span>' : '<span class="tag tag-green">explicit</span>'}</span>`;

    // Args normalization preview
    let argsInfo = '';
    if (inferred === 'tool' && deserResult.args) {
      const args = deserResult.args;
      if (typeof args === 'string') {
        try {
          const parsed = JSON.parse(args);
          argsInfo = `<br><span style="color:var(--cyan);font-size:11px">normalize_tool_args: string → ${JSON.stringify(parsed)}</span>`;
        } catch {
          argsInfo = `<br><span style="color:var(--yellow);font-size:11px">normalize_tool_args: unparseable string → {"input": "${args}"}</span>`;
        }
      } else if (args === null || args === undefined) {
        argsInfo = `<br><span style="color:var(--cyan);font-size:11px">normalize_tool_args: null → {}</span>`;
      }
    }

    resultEl.className = 'parser-result success';
    resultEl.innerHTML = `Action: NextStep\nType: ${inferred} ${wasInferred ? '(inferred)' : '(explicit)'}\n${inferred === 'tool' ? `Tool: ${tool}\nArgs: ${typeof deserResult.args === 'string' ? deserResult.args : JSON.stringify(deserResult.args || {})}` : inferred === 'respond' ? `Message: "${message}"` : `Question: "${question}"`}${argsInfo}`;
  } else {
    valOut.innerHTML = `<span style="color:var(--text3)">Validation skipped (not NextStep)</span>`;
    resultEl.className = 'parser-result success';
    resultEl.textContent = `Action: ${deserResult.type}\n${deserResult.message ? `Message: "${deserResult.message}"` : deserResult.reason ? `Reason: "${deserResult.reason}"` : ''}`;
  }
}

function normalizeControllerValue(value) {
  if (typeof value !== 'object' || Array.isArray(value) || value === null) return value;
  const out = { ...value };

  // Hoist nested step
  const step = out.step || out.next_step;
  if (step && typeof step === 'object') {
    delete out.step; delete out.next_step;
    for (const [k, v] of Object.entries(step)) {
      if (!(k in out)) out[k] = v;
    }
  }

  // Tool name aliases
  for (const alias of ['tool_name', 'name']) {
    if (!out.tool && out[alias]) { out.tool = out[alias]; delete out[alias]; }
  }
  // Args aliases
  for (const alias of ['tool_args', 'arguments', 'tool_input']) {
    if (!out.args && out[alias]) { out.args = out[alias]; delete out[alias]; }
  }
  // Message aliases
  for (const alias of ['response', 'content']) {
    if (!out.message && out[alias]) { out.message = out[alias]; delete out[alias]; }
  }
  return out;
}

document.getElementById('parser-input').addEventListener('input', parseInput);

// ==================== TOOL PIPELINE ====================
function toolStage(stage) {
  const ids = ['tn-args', 'tn-validate', 'tn-approval', 'tn-execute', 'tn-persist', 'tn-record'];
  const map = { args: 0, validate: 1, approval: 2, execute: 3, persist: 4, record: 5 };
  ids.forEach((id, i) => {
    const el = document.getElementById(id);
    el.classList.remove('highlight', 'success-hl', 'warn-hl', 'error-hl', 'purple-hl');
    if (stage === null) return;
    const idx = map[stage];
    if (i < idx) el.classList.add('success-hl');
    else if (i === idx) {
      if (stage === 'approval') el.classList.add('purple-hl');
      else el.classList.add('highlight');
    }
  });
}

// ==================== PROMPT ====================
function copyPrompt() {
  const text = document.getElementById('prompt-text').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = 'Copy', 1500);
  });
}

// ==================== INIT ====================
parseInput();
simReset();
</script>
</body>
</html>
